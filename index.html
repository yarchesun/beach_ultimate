<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–ª—è–∂–Ω–∞—è –ª–∏–≥–∞ ‚Äî –∑–∞—â–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --accent-pink: #ff007a;
      --accent-yellow: #ffb800;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      margin: 0 0 20px;
      font-size: 22px;
      font-weight: 600;
    }
    h1 span {
      color: var(--accent-pink);
    }

    h2 {
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .section {
      padding-bottom: 20px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      outline: none;
      background: #ffffff;
    }
    textarea { min-height: 70px; resize: vertical; }
    input:focus, textarea:focus, select:focus {
      border-color: #3b82f6;
    }

    .row {
      display: grid;
      grid-template-columns: 1.1fr 1.6fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    .stats-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    @media (max-width: 640px) {
      .stats-actions {
        gap: 6px;
      }

      .stats-actions .btn {
        padding: 6px 10px;
        font-size: 11px;
      }
    }



    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-main {
      background: var(--accent-pink);
      border-color: var(--accent-pink);
      color: #ffffff;
    }
    .btn-main-yellow {
      background: var(--accent-yellow);
      border-color: var(--accent-yellow);
      color: #111827;
    }
    .btn-ghost {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 12px;
      padding: 0;
      cursor: pointer;
    }
    .btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .btn-warn {
      background: #fee2e2;      /* —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π */
      border-color: #fecaca;
      color: #991b1b;           /* —Ç—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç */
    }

    .btn-warn:hover {
      background: #fecaca;
    }


    .teams-list {
      margin-top: 8px;
      font-size: 12px;
      color: #4b5563;
      max-height: 120px;
      overflow-y: auto;
    }
    .team-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 3px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .team-name {
      font-weight: 500;
    }

    .select-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .defense-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 6px;
    }
    .defense-row .btn {
      flex: 1;
      justify-content: center;
    }

    .stats-small {
      font-size: 11px;
      color: var(--muted);
    }

    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 4px;
      text-align: left;
    }
    th {
      font-weight: 500;
      color: var(--muted);
      font-size: 11px;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-backdrop.visible { display: flex; }

    .modal {
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px;
      width: min(320px, 92vw);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
    }
    .modal-sub {
      font-size: 12px;
      color: var(--muted);
    }
    .modal-body {
      margin-top: 4px;
      overflow-y: auto;
      max-height: 50vh;
    }

    .mobile-reset {
      display: none;
      margin-top: 12px;
    }

    @media (max-width: 640px) {
      .mobile-reset {
        display: block;
      }

      .desktop-reset {
        display: none;
      }
    }

    .player-btn {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      background: #f9fafb;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .player-btn span:last-child {
      color: var(--muted);
      font-size: 11px;
    }

    .btn-danger {
      background: #000000;
      border-color: #000000;
      color: #ffffff;
    }

    .btn-danger:hover {
      opacity: 0.85;
    }


    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; }
      .select-row { grid-template-columns: 1fr; }
      .defense-row { flex-direction: column; }
    }

   /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
#birthdayModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 2000;
}

/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É */
#birthdayModal.show {
  display: block;
}

/* –ö—Ä–µ—Å—Ç–∏–∫ */
#birthdayModal .close {
  position: absolute; /* absolute –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–æ–¥–∞–ª–∫–∏ */
  top: 16px;
  right: 16px;
  font-size: 32px;
  color: #fff;
  cursor: pointer;
  z-index: 2100; /* –≤—ã—à–µ –≤—Å–µ–≥–æ */
}

/* –ù–∞–¥–ø–∏—Å—å –Ω–∞–¥ —Ñ–æ—Ç–æ */
#birthdayTitle {
  position: absolute;
  top: 16px;
  width: 100%;
  text-align: center;
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  text-shadow: 0 2px 10px rgba(0,0,0,0.6);
  z-index: 2090; /* –Ω–∏–∂–µ –∫—Ä–µ—Å—Ç–∏–∫–∞, –≤—ã—à–µ —Ñ–æ—Ç–æ */
  pointer-events: none;
}

/* –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –≤—ã–ª–µ—Ç–∞ */
#birthdayImg {
  position: absolute; /* –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
  justify-content: center;
  right: 20px;
  bottom: 20px;
  max-width: 90%;
  max-height: 80%; /* —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∞ –∑–∞ —ç–∫—Ä–∞–Ω */
  transform: scale(0.1);
  transform-origin: bottom right;
  transition: transform 0.5s ease;
  z-index: 2080;
}

#birthdayModal.show #birthdayImg {
  transform: scale(1);
}

/* Canvas –¥–ª—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ */
#confettiCanvas {
  position: absolute;
  inset: 0;
  z-index: 2070;
  pointer-events: none;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ */
@media (max-width: 640px) {
  #birthdayTitle {
    font-size: 18px;
    top: 12px;
  }
  #birthdayModal .close {
    font-size: 28px;
    top: 12px;
    right: 12px;
  }
  #birthdayImg {
    max-height: 70%;
    right: 10px;
    bottom: 10px;
  }
}


  </style>
</head>
<body>
<div class="page">
  <h1>–ü–ª—è–∂–Ω–∞—è –ª–∏–≥–∞ ‚Äî <span>–∑–∞—â–∏—Ç–∞</span></h1>

  <!-- –ö–æ–º–∞–Ω–¥—ã -->
  <section class="section">
    <div class="top-row">
      <h2>–ö–æ–º–∞–Ω–¥—ã</h2>
      <button type="submit" form="team-form" class="btn btn-main">
        –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
      </button>
    </div>

    <form id="team-form" autocomplete="off">
      <div class="row">
        <div>
          <label for="team-name-input">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</label>
          <input id="team-name-input" type="text" placeholder="–ö–æ–º–∞–Ω–¥–∞ –ê" required>
        </div>
        <div>
          <label for="team-roster-input">–ò–≥—Ä–æ–∫–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
          <textarea id="team-roster-input" placeholder="–ò–≥—Ä–æ–∫ 1&#10;–ò–≥—Ä–æ–∫ 2&#10;–ò–≥—Ä–æ–∫ 3"></textarea>
        </div>
      </div>
    </form>

    <div class="teams-list" id="teams-list">
      <div class="stats-small">–ö–æ–º–∞–Ω–¥—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>
    </div>
  </section>

  <!-- –ö–Ω–æ–ø–∫–∞ –° –î–º–∏—Ç—Ä–∏–µ–º –†—É–¥–æ–≤—ã–º -->
  <div class="birthday-wrapper">
    <button id="birthdayBtn" class="btn btn-main-yellow">
      –° –î–†!
    </button>
  </div>


  <!-- –¢–µ–∫—É—â–∞—è –∏–≥—Ä–∞ -->
  <section class="section">
    <h2>–¢–µ–∫—É—â–∞—è –∏–≥—Ä–∞</h2>
    <div class="select-row">
      <div>
        <label for="team-a-select">–ö–æ–º–∞–Ω–¥–∞ A</label>
        <select id="team-a-select">
          <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</option>
        </select>
      </div>
      <div>
        <label for="team-b-select">–ö–æ–º–∞–Ω–¥–∞ B</label>
        <select id="team-b-select">
          <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</option>
        </select>
      </div>
    </div>

    <div class="defense-row">
      <button type="button" class="btn btn-main btn-defense" data-defense="A" disabled>
        –ó–∞—â–∏—Ç–∞ ‚Äî –∫–æ–º–∞–Ω–¥–∞ A
      </button>
      <button type="button" class="btn btn-main btn-defense" data-defense="B" disabled>
        –ó–∞—â–∏—Ç–∞ ‚Äî –∫–æ–º–∞–Ω–¥–∞ B
      </button>
    </div>

    <div class="stats-small" id="current-game-caption">
      –ö–æ–º–∞–Ω–¥–∞ A: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ ¬∑ –ö–æ–º–∞–Ω–¥–∞ B: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
    </div>
  </section>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <section class="section">
    <div class="stats-header">
      <div>
        <h2 style="margin-bottom:2px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—â–∏—Ç—ã</h2>
        <div class="stats-small" id="last-action">
          –ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
        </div>
      </div>
      <div class="stats-actions">
      <button type="button" class="btn btn-warn" id="undo-btn" disabled>
        –û—Ç–º–µ–Ω–∏—Ç—å
      </button>
      <button type="button" class="btn btn-main-yellow" id="export-btn" disabled>
        –≠–∫—Å–ø–æ—Ä—Ç Excel
      </button>
      <button type="button" class="btn btn-danger desktop-reset" id="reset-btn">
        –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
      </button>
      </div>
    </div>

    <table>
      <thead>
      <tr>
        <th>–ò–≥—Ä–æ–∫</th>
        <th>–ö–æ–º–∞–Ω–¥–∞</th>
        <th>–ó–∞—â–∏—Ç—ã</th>
        <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ</th>
      </tr>
      </thead>
      <tbody id="stats-body">
      <tr><td colspan="4" class="stats-small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</td></tr>
      </tbody>
    </table>
    <div class="mobile-reset">
      <button type="button" class="btn btn-danger" id="reset-btn-mobile">
        –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
      </button>
</div>

  </section>

  <!-- –û–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ -->
  <div id="birthdayModal" class="modal">
  <span class="close">&times;</span>

  <!-- –ù–∞–¥–ø–∏—Å—å -->
  <div id="birthdayTitle">–° –î–º–∏—Ç—Ä–∏–µ–º –†—É–¥–æ–≤—ã–º!</div>

  <img class="modal-content" id="birthdayImg">

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ -->
  <canvas id="confettiCanvas"></canvas>
</div>


</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞ -->
<div class="modal-backdrop" id="player-modal">
  <div class="modal">
    <div class="modal-header">
      <div>–ó–∞—â–∏—Ç–∞</div>
      <button type="button" class="btn-ghost" id="modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="modal-sub" id="modal-team-name"></div>
    <div class="modal-body" id="modal-player-list"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
<script>
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  const state = {
    teams: [], // {id, name, players: [{id, name, defenseCount, lastTs}]}
    nextTeamId: 1,
    nextPlayerId: 1,
    game: {
      teamAId: null,
      teamBId: null,
      events: [] // {id, teamId, playerId, ts}
    },
    nextEventId: 1
  };

  const STORAGE_KEY = 'beach_ultimate_state';

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const saved = JSON.parse(raw);
    Object.assign(state, saved);
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è', e);
  }
}


  // DOM
  const teamForm = document.getElementById('team-form');
  const teamNameInput = document.getElementById('team-name-input');
  const teamRosterInput = document.getElementById('team-roster-input');
  const teamsListEl = document.getElementById('teams-list');

  const teamASelect = document.getElementById('team-a-select');
  const teamBSelect = document.getElementById('team-b-select');

  const defenseButtons = document.querySelectorAll('.btn-defense');
  const gameCaptionEl = document.getElementById('current-game-caption');

  const lastActionEl = document.getElementById('last-action');
  const statsBodyEl = document.getElementById('stats-body');
  const undoBtn = document.getElementById('undo-btn');
  const exportBtn = document.getElementById('export-btn');
  const resetBtn = document.getElementById('reset-btn');
  const resetBtnMobile = document.getElementById('reset-btn-mobile');


  const playerModal = document.getElementById('player-modal');
  const modalTeamNameEl = document.getElementById('modal-team-name');
  const modalPlayerListEl = document.getElementById('modal-player-list');
  const modalCloseBtn = document.getElementById('modal-close');

  let modalTeamId = null;

  function parseRoster(text) {
    if (!text) return [];
    return text
      .split(/\n/)
      .map(s => s.trim())
      .filter(Boolean)
      .map(name => ({
        id: state.nextPlayerId++,
        name,
        defenseCount: 0,
        lastTs: null
      }));
  }

  function addTeam(name, rosterText) {
    const trimmed = name.trim();
    if (!trimmed) return null;
    const team = {
      id: state.nextTeamId++,
      name: trimmed,
      players: parseRoster(rosterText)
    };
    state.teams.push(team);
    return team;
  }

  function findTeam(id) {
    return state.teams.find(t => t.id === id);
  }

  function findPlayer(teamId, playerId) {
    const team = findTeam(teamId);
    if (!team) return null;
    return team.players.find(p => p.id === playerId);
  }

  function formatTime(ts) {
    if (!ts) return '';
    const d = new Date(ts);
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    const ss = String(d.getSeconds()).padStart(2, '0');
    return `${hh}:${mm}:${ss}`;
  }

  function renderTeamsList() {
    teamsListEl.innerHTML = '';
    if (!state.teams.length) {
      const div = document.createElement('div');
      div.className = 'stats-small';
      div.textContent = '–ö–æ–º–∞–Ω–¥—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.';
      teamsListEl.appendChild(div);
      return;
    }
    state.teams.forEach(team => {
      const row = document.createElement('div');
      row.className = 'team-item';
      const left = document.createElement('div');
      left.className = 'team-name';
      left.textContent = team.name;
      const right = document.createElement('div');
      right.className = 'stats-small';
      right.textContent = `${team.players.length} –∏–≥—Ä–æ–∫–æ–≤`;
      row.appendChild(left);
      row.appendChild(right);
      teamsListEl.appendChild(row);
    });
  }

  function renderTeamSelects() {
    [teamASelect, teamBSelect].forEach(select => {
      const current = Number(select.value) || null;
      select.innerHTML = '';
      const optEmpty = document.createElement('option');
      optEmpty.value = '';
      optEmpty.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
      select.appendChild(optEmpty);
      state.teams.forEach(team => {
        const opt = document.createElement('option');
        opt.value = String(team.id);
        opt.textContent = team.name;
        if (team.id === current) opt.selected = true;
        select.appendChild(opt);
      });
    });
    updateCurrentGameUI();
  }
  function resetAllData() {
  const ok = confirm(
    '–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?\n\n' +
    '–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:\n' +
    '‚Ä¢ –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã\n' +
    '‚Ä¢ –≤—Å–µ –∏–≥—Ä–æ–∫–∏\n' +
    '‚Ä¢ –≤—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n' +
    '–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.'
  );

  if (!ok) return;

  // –æ—á–∏—â–∞–µ–º localStorage
  localStorage.removeItem(STORAGE_KEY);

  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  state.teams = [];
  state.nextTeamId = 1;
  state.nextPlayerId = 1;
  state.game = {
    teamAId: null,
    teamBId: null,
    events: []
  };
  state.nextEventId = 1;

  // –æ–±–Ω–æ–≤–ª—è–µ–º UI
  renderTeamsList();
  renderTeamSelects();
  renderStats();
  updateLastAction(null);
  updateControls();
}

  function updateCurrentGameUI() {
    const teamA = state.game.teamAId ? findTeam(state.game.teamAId) : null;
    const teamB = state.game.teamBId ? findTeam(state.game.teamBId) : null;

    const aName = teamA ? teamA.name : '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
    const bName = teamB ? teamB.name : '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
    const aPlayers = teamA ? teamA.players.length : 0;
    const bPlayers = teamB ? teamB.players.length : 0;

    gameCaptionEl.textContent =
      `–ö–æ–º–∞–Ω–¥–∞ A: ${aName}` +
      (teamA ? ` (${aPlayers} –∏–≥—Ä–æ–∫–æ–≤)` : '') +
      ' ¬∑ ' +
      `–ö–æ–º–∞–Ω–¥–∞ B: ${bName}` +
      (teamB ? ` (${bPlayers} –∏–≥—Ä–æ–∫–æ–≤)` : '');

    defenseButtons.forEach(btn => {
      const slot = btn.dataset.defense;
      const team = slot === 'A' ? teamA : teamB;
      btn.disabled = !(team && team.players.length);
      btn.textContent = team
        ? `–ó–∞—â–∏—Ç–∞ ‚Äî ${team.name}`
        : `–ó–∞—â–∏—Ç–∞ ‚Äî –∫–æ–º–∞–Ω–¥–∞ ${slot}`;
    });

    updateControls();
  }

  function openPlayerModal(teamId) {
    const team = findTeam(teamId);
    if (!team || !team.players.length) return;
    modalTeamId = teamId;
    modalTeamNameEl.textContent = team.name;
    modalPlayerListEl.innerHTML = '';
    team.players.forEach(player => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'player-btn';
      btn.innerHTML = `<span>${player.name}</span><span>${player.defenseCount || 0} –∑–∞—â–∏—Ç</span>`;
      btn.addEventListener('click', () => {
        recordDefense(team.id, player.id);
      });
      modalPlayerListEl.appendChild(btn);
    });
    playerModal.classList.add('visible');
  }

  function closePlayerModal() {
    playerModal.classList.remove('visible');
    modalTeamId = null;
  }

  function recordDefense(teamId, playerId) {
    const team = findTeam(teamId);
    const player = findPlayer(teamId, playerId);
    if (!team || !player) return;
    const ts = Date.now();
    player.defenseCount = (player.defenseCount || 0) + 1;
    player.lastTs = ts;
    const event = { id: state.nextEventId++, teamId, playerId, ts };
    state.game.events.push(event);
    updateLastAction(event);
    saveState();
    renderStats();
    updateCurrentGameUI();
    closePlayerModal();
  }

  function updateLastAction(event) {
    if (!event) {
      lastActionEl.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.';
      return;
    }
    const team = findTeam(event.teamId);
    const player = findPlayer(event.teamId, event.playerId);
    if (!team || !player) {
      lastActionEl.textContent = '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.';
      return;
    }
    lastActionEl.textContent =
      `${formatTime(event.ts)} ¬∑ –∑–∞—â–∏—Ç–∞ –∏–≥—Ä–æ–∫–∞ ¬´${player.name}¬ª (${team.name})`;
  }

  function undoLast() {
    const events = state.game.events;
    if (!events.length) return;
    const last = events.pop();
    const player = findPlayer(last.teamId, last.playerId);
    if (player && player.defenseCount > 0) {
      player.defenseCount -= 1;
      if (player.defenseCount === 0) player.lastTs = null;
    }
    const prev = events[events.length - 1] || null;
    updateLastAction(prev);
    saveState();
    renderStats();
    updateCurrentGameUI();
  }

 function buildStatsData() {
  const rows = [];

  state.teams.forEach(team => {
    team.players.forEach(player => {
      if ((player.defenseCount || 0) > 0) {
        rows.push({
          teamName: team.name,
          playerName: player.name,
          count: player.defenseCount,
          lastTs: player.lastTs
        });
      }
    });
  });

  rows.sort((a, b) => {
    if (b.count !== a.count) return b.count - a.count;
    if (a.teamName !== b.teamName) return a.teamName.localeCompare(b.teamName);
    return a.playerName.localeCompare(b.playerName);
  });

  return rows;
}

  function renderStats() {
    statsBodyEl.innerHTML = '';
    const data = buildStatsData();
    if (!data.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.className = 'stats-small';
      td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
      tr.appendChild(td);
      statsBodyEl.appendChild(tr);
      return;
    }
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${row.playerName}</td>` +
        `<td>${row.teamName}</td>` +
        `<td>${row.count}</td>` +
        `<td>${row.lastTs ? formatTime(row.lastTs) : ''}</td>`;
      statsBodyEl.appendChild(tr);
    });
  }

  function updateControls() {
    undoBtn.disabled = !state.game.events.length;
    const hasTeams = state.game.teamAId && state.game.teamBId;
    const hasData = buildStatsData().length > 0;
    exportBtn.disabled = !(hasTeams && hasData);
  }

  function exportExcel() {
  const data = buildStatsData();
  if (!data.length) return;

  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ + –¥–∞–Ω–Ω—ã–µ
  const sheetData = [
    ['–ö–æ–º–∞–Ω–¥–∞', '–ò–≥—Ä–æ–∫', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—â–∏—Ç', '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ'],
    ...data.map(row => [
      row.teamName,
      row.playerName,
      row.count,
      row.lastTs ? formatTime(row.lastTs) : ''
    ])
  ];

  // –°–æ–∑–¥–∞—ë–º –ª–∏—Å—Ç
  const ws = XLSX.utils.aoa_to_sheet(sheetData);

  // üëâ –®–∏—Ä–∏–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ (–≤ —Å–∏–º–≤–æ–ª–∞—Ö)
  ws['!cols'] = [
    { wch: 22 }, // –ö–æ–º–∞–Ω–¥–∞
    { wch: 20 }, // –ò–≥—Ä–æ–∫
    { wch: 18 }, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—â–∏—Ç
    { wch: 20 }  // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
  ];

  // –°–æ–∑–¥–∞—ë–º –∫–Ω–∏–≥—É
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');

  // –ò–º—è —Ñ–∞–π–ª–∞
  const d = new Date();
  const stamp =
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}_` +
    `${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;

  XLSX.writeFile(wb, `defense_stats_${stamp}.xlsx`);
}

  // –°–ª—É—à–∞—Ç–µ–ª–∏
  teamForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = teamNameInput.value;
    const roster = teamRosterInput.value;
    const team = addTeam(name, roster);
    if (!team) return;
    saveState();
    teamNameInput.value = '';
    teamRosterInput.value = '';
    renderTeamsList();
    renderTeamSelects();
    renderStats();
  });

  teamASelect.addEventListener('change', () => {
    const val = Number(teamASelect.value) || null;
    if (val && val === state.game.teamBId) {
      alert('–ö–æ–º–∞–Ω–¥—ã A –∏ B –Ω–µ –º–æ–≥—É—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å.');
      teamASelect.value = '';
      state.game.teamAId = null;
    } else {
      state.game.teamAId = val;
    }
    saveState();
    updateCurrentGameUI();
    renderStats();
  });

  teamBSelect.addEventListener('change', () => {
    const val = Number(teamBSelect.value) || null;
    if (val && val === state.game.teamAId) {
      alert('–ö–æ–º–∞–Ω–¥—ã A –∏ B –Ω–µ –º–æ–≥—É—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å.');
      teamBSelect.value = '';
      state.game.teamBId = null;
    } else {
      state.game.teamBId = val;
    }
    saveState();
    updateCurrentGameUI();
    renderStats();
  });

  resetBtn.addEventListener('click', resetAllData);
  resetBtnMobile.addEventListener('click', resetAllData);

  defenseButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const slot = btn.dataset.defense;
      const teamId = slot === 'A' ? state.game.teamAId : state.game.teamBId;
      if (teamId) openPlayerModal(teamId);
    });
  });

  modalCloseBtn.addEventListener('click', closePlayerModal);
  playerModal.addEventListener('click', e => {
    if (e.target === playerModal) closePlayerModal();
  });

  undoBtn.addEventListener('click', undoLast);
  exportBtn.addEventListener('click', exportExcel);

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && modalTeamId) {
      closePlayerModal();
    }
  });

  // –≠–ª–µ–º–µ–Ω—Ç—ã
const birthdayBtn = document.getElementById("birthdayBtn");
const birthdayModal = document.getElementById("birthdayModal");
const birthdayImg = document.getElementById("birthdayImg");
const birthdayClose = birthdayModal.querySelector(".close");

// –ü—É—Ç—å –∫ —Ñ–æ—Ç–æ
const birthdayPhoto = "dr.jpg";

// üéä –ö–æ–Ω—Ñ–µ—Ç—Ç–∏
const confettiCanvas = document.getElementById("confettiCanvas");
const ctx = confettiCanvas.getContext("2d");

let confetti = [];
let confettiAnimation;

function resizeCanvas() {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function createConfetti() {
  confetti = [];
  for (let i = 0; i < 150; i++) {
    confetti.push({
      x: Math.random() * confettiCanvas.width,
      y: Math.random() * -confettiCanvas.height,
      r: Math.random() * 6 + 4,
      d: Math.random() * 5 + 2,
      color: `hsl(${Math.random() * 360}, 100%, 50%)`,
      tilt: Math.random() * 10 - 10
    });
  }
}

function drawConfetti() {
  ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

  confetti.forEach(c => {
    ctx.beginPath();
    ctx.fillStyle = c.color;
    ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
    ctx.fill();
  });

  updateConfetti();
}

function updateConfetti() {
  confetti.forEach(c => {
    c.y += c.d;
    c.x += Math.sin(c.tilt);

    if (c.y > confettiCanvas.height) {
      c.y = -10;
      c.x = Math.random() * confettiCanvas.width;
    }
  });
}

function startConfetti() {
  createConfetti();
  confettiAnimation = setInterval(drawConfetti, 20);
}

function stopConfetti() {
  clearInterval(confettiAnimation);
  ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
}


birthdayBtn.onclick = () => {
  birthdayImg.src = birthdayPhoto;
  birthdayModal.classList.add("show");
  startConfetti(); // –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
};

birthdayClose.onclick = () => {
  birthdayModal.classList.remove("show");
  stopConfetti(); // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
};

window.onclick = (e) => {
  if (e.target === birthdayModal) {
    birthdayModal.classList.remove("show");
    stopConfetti();
  }
};



  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  loadState();
  renderTeamsList();
  renderTeamSelects();
  renderStats();
  updateLastAction(null);
</script>
</body>
</html>















